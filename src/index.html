<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data:;">
  <title>Análisis de Archivos de Preimpresión</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body {
      -webkit-app-region: drag;
    }
    button, input, .drop-zone, .no-drag {
      -webkit-app-region: no-drag;
    }
    .drop-zone {
      transition: all 0.3s ease;
    }
    .drop-zone.dragover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    .status-ready { color: #16a34a; }
    .status-warning { color: #ca8a04; }
    .status-error { color: #dc2626; }
    .bg-status-ready { background-color: #dcfce7; border-color: #16a34a; }
    .bg-status-warning { background-color: #fef9c3; border-color: #ca8a04; }
    .bg-status-error { background-color: #fee2e2; border-color: #dc2626; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-4 pt-8">
    <!-- Header -->
    <header class="flex items-center gap-4 mb-6 no-drag">
      <div class="text-4xl font-bold text-gray-800">
        <span class="border-b-4 border-gray-800">DN</span>
      </div>
      <div>
        <h1 class="text-2xl font-semibold text-gray-800">Análisis de Archivos de Preimpresión</h1>
        <p class="text-gray-500 text-sm">Validación para impresión en papel prensa</p>
      </div>
    </header>

    <!-- Technical Specifications Panel -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 no-drag">
      <div class="flex items-start gap-2">
        <i class="fas fa-info-circle text-blue-500 mt-1"></i>
        <div class="text-sm">
          <p class="font-semibold text-blue-800 mb-1">Especificaciones técnicas:</p>
          <ul class="text-blue-700 space-y-0.5">
            <li>• Resolución mínima: <strong>200 dpi</strong></li>
            <li>• Espacio de color: <strong>CMYK</strong> (ISONewspaper/Euroestándar)</li>
            <li>• Cobertura máxima de tinta: <strong>240-250%</strong></li>
            <li>• Formatos soportados: <strong>PDF, JPG, TIFF, EPS</strong></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Drop Zone -->
    <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 mb-6 no-drag">
      <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
      <p class="text-gray-600 font-medium">Arrastra tu archivo aquí</p>
      <p class="text-gray-400 text-sm">o haz clic para seleccionar</p>
      <p class="text-gray-400 text-xs mt-2">Formatos: PDF, JPG, TIFF, EPS (máx. 50 MB)</p>
    </div>

    <!-- Progress Bar -->
    <div id="progressContainer" class="hidden mb-6 no-drag">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-600">Analizando archivo...</span>
        <span id="progressText" class="text-sm text-gray-600">0%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progressBar" class="progress-bar bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden no-drag">
      <!-- File Info Card -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
        <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-file text-blue-500"></i>
          Información del Archivo
        </h2>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <p class="text-xs text-gray-500 mb-1">Nombre</p>
            <p id="fileName" class="text-sm font-medium text-gray-800 truncate"></p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">Tipo</p>
            <p id="fileType" class="text-sm font-medium text-gray-800"></p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">Tamaño</p>
            <p id="fileSize" class="text-sm font-medium text-gray-800"></p>
          </div>
        </div>
      </div>

      <!-- Technical Analysis Card -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-search-plus text-blue-500"></i>
          Análisis Técnico
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Preview Column -->
          <div>
            <p class="text-xs text-gray-500 mb-2 flex items-center gap-1">
              <i class="fas fa-eye"></i>
              Previsualización
            </p>
            <div id="previewContainer" class="border border-gray-200 rounded-lg bg-gray-50 p-2 min-h-[200px] flex items-center justify-center">
              <p class="text-gray-400 text-sm">Vista previa no disponible</p>
            </div>
            <p id="previewLabel" class="text-xs text-gray-400 mt-1 text-center"></p>
          </div>

          <!-- Analysis Details Column -->
          <div class="space-y-4">
            <!-- Dimensions -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-ruler-combined"></i>
                Dimensiones
              </p>
              <p id="dimensions" class="text-sm text-gray-800"></p>
              <p id="physicalDimensions" class="text-xs text-gray-500"></p>
            </div>

            <!-- Resolution -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-th"></i>
                Resolución
              </p>
              <p id="resolution" class="text-sm"></p>
            </div>

            <!-- Color Space -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-palette"></i>
                Espacio de Color
              </p>
              <p id="colorSpace" class="text-sm"></p>
            </div>

            <!-- ICC Profile -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-certificate"></i>
                Perfil ICC
              </p>
              <p id="iccProfile" class="text-sm"></p>
            </div>

            <!-- Ink Coverage -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-tint"></i>
                Cobertura de Tinta
              </p>
              <p class="text-sm text-gray-600">
                <i class="fas fa-info-circle text-gray-400"></i>
                Análisis detallado de cobertura de tinta requiere procesamiento adicional
              </p>
              <p class="text-xs text-gray-400">Máximo permitido: 240-250%</p>
            </div>

            <!-- Black Text -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-font"></i>
                Textos en Negro
              </p>
              <p class="text-sm text-gray-600">
                <i class="fas fa-info-circle text-gray-400"></i>
                Análisis de textos requiere procesamiento adicional
              </p>
              <p class="text-xs text-gray-400">Los textos deben estar en negro 100% (K=100, C=M=Y=0)</p>
            </div>

            <!-- Text Readability -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-glasses"></i>
                Legibilidad del Texto
              </p>
              <p id="textReadability" class="text-sm"></p>
              <p id="textReadabilityDetails" class="text-xs text-gray-400"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Printability Status Card -->
      <div id="printabilityCard" class="rounded-lg border-2 p-4 mb-4">
        <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
          <i id="printabilityIcon" class="fas fa-print"></i>
          <span id="printabilityTitle">Estado de Imprimibilidad</span>
        </h2>
        <div id="issuesList" class="mb-3"></div>
        <div id="recommendationsList"></div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-gray-400 text-xs mt-8 pb-4 no-drag">
      ©A. Meléndez, 2026 rev.1
    </footer>
  </div>

  <script>
    // Initialize PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const dropZone = document.getElementById('dropZone');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultsSection = document.getElementById('resultsSection');

    let currentFilePath = null;

    // Click to open file dialog
    dropZone.addEventListener('click', async () => {
      const filePath = await window.electronAPI.openFileDialog();
      if (filePath) {
        handleFile(filePath);
      }
    });

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const filePath = files[0].path;
        handleFile(filePath);
      }
    });

    async function handleFile(filePath) {
      currentFilePath = filePath;
      resultsSection.classList.add('hidden');
      progressContainer.classList.remove('hidden');

      // Animate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        updateProgress(progress);
      }, 100);

      try {
        const response = await window.electronAPI.analyzeFile(filePath);

        clearInterval(progressInterval);
        updateProgress(100);

        if (!response.success) {
          throw new Error(response.error);
        }

        setTimeout(() => {
          progressContainer.classList.add('hidden');
          displayResults(response.data, filePath);
        }, 300);

      } catch (error) {
        clearInterval(progressInterval);
        progressContainer.classList.add('hidden');
        alert('Error: ' + error.message);
      }
    }

    function updateProgress(value) {
      progressBar.style.width = value + '%';
      progressText.textContent = Math.round(value) + '%';
    }

    async function displayResults(result, filePath) {
      // File info
      document.getElementById('fileName').textContent = result.fileName;
      document.getElementById('fileType').textContent = result.fileType;
      document.getElementById('fileSize').textContent = result.fileSize;

      // Dimensions
      const dimUnit = result.dimensions.unit === 'mm' ? 'mm' : 'px';
      document.getElementById('dimensions').innerHTML =
        `<strong>Ancho:</strong> ${result.dimensions.width} ${dimUnit}<br>` +
        `<strong>Alto:</strong> ${result.dimensions.height} ${dimUnit}`;

      if (result.physicalDimensions) {
        document.getElementById('physicalDimensions').textContent =
          `Dimensiones físicas: ${result.physicalDimensions.width} × ${result.physicalDimensions.height} mm`;
      } else {
        document.getElementById('physicalDimensions').textContent = '';
      }

      // Resolution
      const resEl = document.getElementById('resolution');
      if (result.resolution.value === 'Vector') {
        resEl.innerHTML = '<span class="status-ready"><i class="fas fa-check-circle"></i> Vector (resolución no aplicable)</span>';
      } else {
        const resStatus = result.resolution.value >= 200 ? 'ready' : 'error';
        const icon = resStatus === 'ready' ? 'check-circle' : 'times-circle';
        resEl.innerHTML = `<span class="status-${resStatus}"><i class="fas fa-${icon}"></i> ${result.resolution.value} dpi</span>`;
        if (result.resolution.message) {
          resEl.innerHTML += `<br><span class="text-xs text-gray-400">${result.resolution.message}</span>`;
        }
      }

      // Color Space
      const colorEl = document.getElementById('colorSpace');
      const colorStatus = result.colorSpace === 'CMYK' ? 'ready' : (result.colorSpace === 'RGB' ? 'warning' : 'error');
      const colorIcon = colorStatus === 'ready' ? 'check-circle' : (colorStatus === 'warning' ? 'exclamation-triangle' : 'times-circle');
      colorEl.innerHTML = `<span class="status-${colorStatus}"><i class="fas fa-${colorIcon}"></i> ${result.colorSpace}</span>`;

      // ICC Profile
      const iccEl = document.getElementById('iccProfile');
      if (result.hasICCProfile) {
        const iccText = result.iccProfile ? `Perfil ICC detectado (${result.iccProfile})` : 'Perfil ICC detectado';
        iccEl.innerHTML = `<span class="status-ready"><i class="fas fa-check-circle"></i> ${iccText}</span>`;
      } else {
        iccEl.innerHTML = '<span class="status-warning"><i class="fas fa-exclamation-triangle"></i> Sin perfil ICC embebido</span>';
      }

      // Text Readability
      const readabilityEl = document.getElementById('textReadability');
      const readabilityDetailsEl = document.getElementById('textReadabilityDetails');
      if (result.textReadability) {
        const readStatus = result.textReadability.status;
        let readIcon, readClass, readText;

        if (readStatus === 'legible') {
          readIcon = 'check-circle';
          readClass = 'ready';
          readText = 'Legible';
        } else if (readStatus === 'warning') {
          readIcon = 'exclamation-triangle';
          readClass = 'warning';
          readText = 'Posibles problemas de legibilidad';
        } else if (readStatus === 'no-legible') {
          readIcon = 'times-circle';
          readClass = 'error';
          readText = 'No legible';
        } else {
          readIcon = 'question-circle';
          readClass = 'warning';
          readText = 'No determinado';
        }

        readabilityEl.innerHTML = `<span class="status-${readClass}"><i class="fas fa-${readIcon}"></i> ${readText}</span>`;

        if (result.textReadability.minFontSize) {
          readabilityEl.innerHTML += `<br><span class="text-xs text-gray-500">Tamaño mínimo: ${result.textReadability.minFontSize}pt</span>`;
        }

        if (result.textReadability.details && result.textReadability.details.length > 0) {
          readabilityDetailsEl.textContent = result.textReadability.details[0];
        } else {
          readabilityDetailsEl.textContent = '';
        }
      } else {
        readabilityEl.innerHTML = '<span class="text-gray-500"><i class="fas fa-info-circle"></i> No analizado</span>';
        readabilityDetailsEl.textContent = '';
      }

      // Printability
      const printCard = document.getElementById('printabilityCard');
      const printIcon = document.getElementById('printabilityIcon');
      const printTitle = document.getElementById('printabilityTitle');
      const issuesList = document.getElementById('issuesList');
      const recsList = document.getElementById('recommendationsList');

      printCard.className = 'rounded-lg border-2 p-4 mb-4 bg-status-' + result.printability.status;

      const statusLabels = {
        ready: 'Listo para imprimir',
        warning: 'Requiere atención',
        error: 'No apto para impresión'
      };
      const statusIcons = {
        ready: 'check-circle',
        warning: 'exclamation-triangle',
        error: 'times-circle'
      };

      printIcon.className = `fas fa-${statusIcons[result.printability.status]} status-${result.printability.status}`;
      printTitle.textContent = statusLabels[result.printability.status];
      printTitle.className = `status-${result.printability.status}`;

      // Issues
      if (result.printability.issues.length > 0) {
        issuesList.innerHTML = '<p class="text-sm font-medium text-gray-700 mb-1">Problemas detectados:</p>' +
          result.printability.issues.map(issue =>
            `<p class="text-sm text-gray-600 ml-2">• ${issue}</p>`
          ).join('');
      } else {
        issuesList.innerHTML = '';
      }

      // Recommendations
      if (result.recommendations.length > 0) {
        recsList.innerHTML = '<p class="text-sm font-medium text-gray-700 mb-1 mt-2">Recomendaciones:</p>' +
          result.recommendations.map(rec =>
            `<p class="text-sm text-gray-600 ml-2">• ${rec}</p>`
          ).join('');
      } else {
        recsList.innerHTML = '';
      }

      // Preview
      await generatePreview(filePath, result.fileType);

      resultsSection.classList.remove('hidden');
    }

    async function generatePreview(filePath, fileType) {
      const container = document.getElementById('previewContainer');
      const label = document.getElementById('previewLabel');

      container.innerHTML = '<p class="text-gray-400 text-sm">Cargando vista previa...</p>';

      try {
        const response = await window.electronAPI.readFileForPreview(filePath);

        if (!response.success) {
          throw new Error(response.error);
        }

        container.innerHTML = '';

        if (response.type === 'image') {
          const img = document.createElement('img');
          img.src = response.data;
          img.className = 'max-w-full max-h-[250px] object-contain rounded';
          img.alt = 'Vista previa';
          container.appendChild(img);
          label.textContent = 'Imagen JPEG';
        } else if (response.type === 'pdf') {
          try {
            const pdfData = atob(response.data);
            const pdfArray = new Uint8Array(pdfData.length);
            for (let i = 0; i < pdfData.length; i++) {
              pdfArray[i] = pdfData.charCodeAt(i);
            }

            const pdf = await pdfjsLib.getDocument({ data: pdfArray }).promise;
            const page = await pdf.getPage(1);

            const scale = 1.5;
            const viewport = page.getViewport({ scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.className = 'max-w-full max-h-[250px] object-contain rounded shadow-sm';

            await page.render({
              canvasContext: context,
              viewport: viewport
            }).promise;

            const maxHeight = 250;
            if (canvas.height > maxHeight) {
              const ratio = maxHeight / canvas.height;
              canvas.style.width = (canvas.width * ratio) + 'px';
              canvas.style.height = maxHeight + 'px';
            }

            container.appendChild(canvas);
            label.textContent = `Documento PDF (página 1 de ${pdf.numPages})`;
          } catch (pdfError) {
            container.innerHTML = '<p class="text-gray-400 text-sm">No se pudo generar vista previa del PDF</p>';
            label.textContent = '';
          }
        } else {
          if (fileType === 'TIFF') {
            container.innerHTML = `
              <div class="text-center p-4">
                <i class="fas fa-file-image text-4xl text-gray-300 mb-2"></i>
                <p class="text-gray-400 text-sm">Vista previa no disponible para TIFF</p>
                <p class="text-gray-400 text-xs">Los navegadores no soportan preview directo</p>
              </div>
            `;
            label.textContent = 'Archivo TIFF';
          } else if (fileType === 'EPS') {
            container.innerHTML = `
              <div class="text-center p-4">
                <i class="fas fa-vector-square text-4xl text-gray-300 mb-2"></i>
                <p class="text-gray-400 text-sm">Vista previa no disponible para EPS</p>
                <p class="text-gray-400 text-xs">Archivo vectorial PostScript</p>
              </div>
            `;
            label.textContent = 'Archivo EPS (vectorial)';
          } else {
            container.innerHTML = '<p class="text-gray-400 text-sm">Vista previa no disponible</p>';
            label.textContent = '';
          }
        }
      } catch (error) {
        container.innerHTML = '<p class="text-gray-400 text-sm">Error al cargar vista previa</p>';
        label.textContent = '';
      }
    }
  </script>
</body>
</html>
