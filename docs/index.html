<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Análisis de Archivos de Preimpresión</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    .drop-zone {
      transition: all 0.3s ease;
    }
    .drop-zone.dragover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    .status-ready { color: #16a34a; }
    .status-warning { color: #ca8a04; }
    .status-error { color: #dc2626; }
    .bg-status-ready { background-color: #dcfce7; border-color: #16a34a; }
    .bg-status-warning { background-color: #fef9c3; border-color: #ca8a04; }
    .bg-status-error { background-color: #fee2e2; border-color: #dc2626; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-4">
    <!-- Header -->
    <header class="flex items-center gap-4 mb-6">
      <div class="text-4xl font-bold text-gray-800">
        <span class="border-b-4 border-gray-800">DN</span>
      </div>
      <div>
        <h1 class="text-2xl font-semibold text-gray-800">Análisis de Archivos de Preimpresión</h1>
        <p class="text-gray-500 text-sm">Validación para impresión en papel prensa</p>
      </div>
    </header>

    <!-- Technical Specifications Panel -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <div class="flex items-start gap-2">
        <i class="fas fa-info-circle text-blue-500 mt-1"></i>
        <div class="text-sm">
          <p class="font-semibold text-blue-800 mb-1">Especificaciones técnicas:</p>
          <ul class="text-blue-700 space-y-0.5">
            <li>• Resolución mínima: <strong>200 dpi</strong></li>
            <li>• Espacio de color: <strong>CMYK</strong> (ISONewspaper/Euroestándar)</li>
            <li>• Cobertura máxima de tinta: <strong>240-250%</strong></li>
            <li>• Formatos soportados: <strong>PDF, JPG, TIFF, EPS</strong></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Drop Zone -->
    <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 mb-6">
      <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
      <p class="text-gray-600 font-medium">Arrastra tu archivo aquí</p>
      <p class="text-gray-400 text-sm">o haz clic para seleccionar</p>
      <p class="text-gray-400 text-xs mt-2">Formatos: PDF, JPG, TIFF, EPS (máx. 50 MB)</p>
      <input type="file" id="fileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.tif,.tiff,.eps">
    </div>

    <!-- Progress Bar -->
    <div id="progressContainer" class="hidden mb-6">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-600">Analizando archivo...</span>
        <span id="progressText" class="text-sm text-gray-600">0%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progressBar" class="progress-bar bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden">
      <!-- File Info Card -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
        <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-file text-blue-500"></i>
          Información del Archivo
        </h2>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <p class="text-xs text-gray-500 mb-1">Nombre</p>
            <p id="fileName" class="text-sm font-medium text-gray-800 truncate"></p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">Tipo</p>
            <p id="fileType" class="text-sm font-medium text-gray-800"></p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">Tamaño</p>
            <p id="fileSize" class="text-sm font-medium text-gray-800"></p>
          </div>
        </div>
      </div>

      <!-- Technical Analysis Card -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-search-plus text-blue-500"></i>
          Análisis Técnico
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Preview Column -->
          <div>
            <p class="text-xs text-gray-500 mb-2 flex items-center gap-1">
              <i class="fas fa-eye"></i>
              Previsualización
            </p>
            <div id="previewContainer" class="border border-gray-200 rounded-lg bg-gray-50 p-2 min-h-[200px] flex items-center justify-center">
              <p class="text-gray-400 text-sm">Vista previa no disponible</p>
            </div>
            <p id="previewLabel" class="text-xs text-gray-400 mt-1 text-center"></p>
          </div>

          <!-- Analysis Details Column -->
          <div class="space-y-4">
            <!-- Dimensions -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-ruler-combined"></i>
                Dimensiones
              </p>
              <p id="dimensions" class="text-sm text-gray-800"></p>
              <p id="physicalDimensions" class="text-xs text-gray-500"></p>
            </div>

            <!-- Resolution -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-th"></i>
                Resolución
              </p>
              <p id="resolution" class="text-sm"></p>
            </div>

            <!-- Color Space -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-palette"></i>
                Espacio de Color
              </p>
              <p id="colorSpace" class="text-sm"></p>
            </div>

            <!-- ICC Profile -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-certificate"></i>
                Perfil ICC
              </p>
              <p id="iccProfile" class="text-sm"></p>
            </div>

            <!-- Ink Coverage -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-tint"></i>
                Cobertura de Tinta
              </p>
              <p class="text-sm text-gray-600">
                <i class="fas fa-info-circle text-gray-400"></i>
                Análisis detallado de cobertura de tinta requiere procesamiento adicional
              </p>
              <p class="text-xs text-gray-400">Máximo permitido: 240-250%</p>
            </div>

            <!-- Black Text -->
            <div>
              <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                <i class="fas fa-font"></i>
                Textos en Negro
              </p>
              <p class="text-sm text-gray-600">
                <i class="fas fa-info-circle text-gray-400"></i>
                Análisis de textos requiere procesamiento adicional
              </p>
              <p class="text-xs text-gray-400">Los textos deben estar en negro 100% (K=100, C=M=Y=0)</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Printability Status Card -->
      <div id="printabilityCard" class="rounded-lg border-2 p-4 mb-4">
        <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
          <i id="printabilityIcon" class="fas fa-print"></i>
          <span id="printabilityTitle">Estado de Imprimibilidad</span>
        </h2>
        <div id="issuesList" class="mb-3"></div>
        <div id="recommendationsList"></div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-gray-400 text-xs mt-8 pb-4">
      ©A. Meléndez, 2026 rev.1
    </footer>
  </div>

  <script>
    // Initialize PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // ==================== FILE ANALYZERS ====================

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function pxToMm(px, dpi) {
      return Math.round((px / dpi) * 25.4 * 10) / 10;
    }

    // PDF Analyzer
    function analyzePDF(buffer, fileName) {
      const bytes = new Uint8Array(buffer);
      const text = new TextDecoder('latin1').decode(bytes);

      let width = 595;
      let height = 842;
      const mediaBoxMatch = text.match(/\/MediaBox\s*\[\s*([\d.-]+)\s+([\d.-]+)\s+([\d.-]+)\s+([\d.-]+)\s*\]/);
      if (mediaBoxMatch) {
        width = Math.abs(parseFloat(mediaBoxMatch[3]) - parseFloat(mediaBoxMatch[1]));
        height = Math.abs(parseFloat(mediaBoxMatch[4]) - parseFloat(mediaBoxMatch[2]));
      }

      const widthMm = Math.round(width * 0.352778 * 10) / 10;
      const heightMm = Math.round(height * 0.352778 * 10) / 10;

      let colorSpace = 'unknown';
      if (text.includes('/DeviceCMYK') || (text.includes('/ICCBased') && text.includes('CMYK'))) {
        colorSpace = 'CMYK';
      } else if (text.includes('/DeviceRGB')) {
        colorSpace = 'RGB';
      } else if (text.includes('/DeviceGray')) {
        colorSpace = 'Grayscale';
      }

      let hasICCProfile = false;
      let iccProfile = undefined;
      if (text.includes('/ICCBased') || text.includes('/OutputIntent')) {
        hasICCProfile = true;
        if (text.includes('ISONewspaper') || text.includes('ISOnewspaper')) {
          iccProfile = 'ISONewspaper';
        } else if (text.includes('Eurostandard') || text.includes('EuroStandard')) {
          iccProfile = 'Euroestándar';
        } else if (text.includes('sRGB')) {
          iccProfile = 'sRGB';
        } else if (text.includes('AdobeRGB')) {
          iccProfile = 'Adobe RGB';
        }
      }

      const issues = [];
      const recommendations = [];

      if (colorSpace === 'RGB') {
        issues.push('El archivo está en RGB, se requiere conversión a CMYK');
        recommendations.push('Convertir a CMYK con perfil ISONewspaper o Euroestándar');
      } else if (colorSpace === 'unknown') {
        issues.push('No se pudo detectar el espacio de color');
      }

      if (!hasICCProfile) {
        issues.push('No se detectó perfil ICC embebido');
        recommendations.push('Se recomienda embeber perfil ISONewspaper para impresión en papel prensa');
      } else if (iccProfile && !['ISONewspaper', 'Euroestándar'].includes(iccProfile)) {
        issues.push(`Perfil ICC "${iccProfile}" no es óptimo para papel prensa`);
        recommendations.push('Convertir a perfil ISONewspaper o Euroestándar');
      }

      let status = 'ready';
      if (colorSpace === 'RGB' || colorSpace === 'unknown') {
        status = 'error';
      } else if (issues.length > 0) {
        status = 'warning';
      }

      if (recommendations.length === 0 && status === 'ready') {
        recommendations.push('Archivo listo para impresión en papel prensa');
      }

      return {
        fileName,
        fileType: 'PDF',
        fileSize: formatFileSize(buffer.byteLength),
        dimensions: { width: widthMm, height: heightMm, unit: 'mm' },
        resolution: { value: 300, status: 'default', message: 'PDF - resolución estimada por defecto' },
        colorSpace,
        hasICCProfile,
        iccProfile,
        printability: { status, issues },
        recommendations
      };
    }

    // JPG Analyzer
    function analyzeJPG(buffer, fileName) {
      const bytes = new Uint8Array(buffer);
      let width = 0, height = 0, dpiX = 72, dpiY = 72;
      let colorSpace = 'RGB', hasICCProfile = false, iccProfile = undefined, dpiDetected = false;
      let offset = 2;

      if (bytes[0] !== 0xFF || bytes[1] !== 0xD8) throw new Error('Archivo JPG inválido');

      while (offset < bytes.length - 1) {
        if (bytes[offset] !== 0xFF) { offset++; continue; }
        const marker = bytes[offset + 1];
        if (marker === 0xD9) break;
        if (marker === 0xD8 || marker === 0x01 || (marker >= 0xD0 && marker <= 0xD7)) { offset += 2; continue; }
        const segmentLength = (bytes[offset + 2] << 8) | bytes[offset + 3];

        if (marker === 0xE0) {
          const jfifId = String.fromCharCode(bytes[offset + 4], bytes[offset + 5], bytes[offset + 6], bytes[offset + 7]);
          if (jfifId === 'JFIF') {
            const units = bytes[offset + 11];
            dpiX = (bytes[offset + 12] << 8) | bytes[offset + 13];
            dpiY = (bytes[offset + 14] << 8) | bytes[offset + 15];
            if (units === 1) dpiDetected = true;
            else if (units === 2) { dpiX = Math.round(dpiX * 2.54); dpiY = Math.round(dpiY * 2.54); dpiDetected = true; }
          }
        }

        if (marker === 0xE2) {
          const iccId = String.fromCharCode(bytes[offset + 4], bytes[offset + 5], bytes[offset + 6], bytes[offset + 7],
            bytes[offset + 8], bytes[offset + 9], bytes[offset + 10], bytes[offset + 11]);
          if (iccId.startsWith('ICC_PROF')) {
            hasICCProfile = true;
            const profileData = new TextDecoder('latin1').decode(bytes.slice(offset + 18, offset + 2 + segmentLength));
            if (profileData.includes('ISONewspaper') || profileData.includes('ISOnewspaper')) iccProfile = 'ISONewspaper';
            else if (profileData.includes('Eurostandard') || profileData.includes('EuroStandard')) iccProfile = 'Euroestándar';
            else if (profileData.includes('sRGB')) iccProfile = 'sRGB';
            else if (profileData.includes('AdobeRGB') || profileData.includes('Adobe RGB')) iccProfile = 'Adobe RGB';
            else if (profileData.includes('CMYK')) iccProfile = 'CMYK Profile';
          }
        }

        if ((marker >= 0xC0 && marker <= 0xC3) || (marker >= 0xC5 && marker <= 0xC7) ||
            (marker >= 0xC9 && marker <= 0xCB) || (marker >= 0xCD && marker <= 0xCF)) {
          height = (bytes[offset + 5] << 8) | bytes[offset + 6];
          width = (bytes[offset + 7] << 8) | bytes[offset + 8];
          const components = bytes[offset + 9];
          if (components === 1) colorSpace = 'Grayscale';
          else if (components === 3) colorSpace = 'RGB';
          else if (components === 4) colorSpace = 'CMYK';
        }

        offset += 2 + segmentLength;
      }

      const dpi = Math.max(dpiX, dpiY);
      const issues = [], recommendations = [];

      if (dpi < 200) {
        issues.push(`Resolución de ${dpi} dpi es inferior al mínimo de 200 dpi`);
        recommendations.push('Redimensionar imagen o usar una versión de mayor resolución');
      }
      if (colorSpace === 'RGB') {
        issues.push('El archivo está en RGB, se recomienda convertir a CMYK');
        recommendations.push('Convertir a CMYK con perfil ISONewspaper o Euroestándar');
      }
      if (!hasICCProfile) {
        issues.push('No se detectó perfil ICC embebido');
        recommendations.push('Se recomienda embeber perfil ICC apropiado');
      } else if (iccProfile && !['ISONewspaper', 'Euroestándar', 'CMYK Profile'].includes(iccProfile)) {
        issues.push(`Perfil ICC "${iccProfile}" no es óptimo para papel prensa`);
        recommendations.push('Convertir a perfil ISONewspaper o Euroestándar');
      }

      let status = 'ready';
      if (dpi < 200) status = 'error';
      else if (colorSpace === 'RGB' || issues.length > 0) status = 'warning';

      if (recommendations.length === 0 && status === 'ready') recommendations.push('Archivo listo para impresión en papel prensa');

      return {
        fileName, fileType: 'JPG', fileSize: formatFileSize(buffer.byteLength),
        dimensions: { width, height, unit: 'px' },
        physicalDimensions: dpiDetected ? { width: pxToMm(width, dpi), height: pxToMm(height, dpi), unit: 'mm' } : undefined,
        resolution: { value: dpi, status: dpiDetected ? 'detected' : 'default', message: dpiDetected ? undefined : 'Resolución no detectada, usando 72 dpi por defecto' },
        colorSpace, hasICCProfile, iccProfile,
        printability: { status, issues }, recommendations
      };
    }

    // TIFF Analyzer
    function analyzeTIFF(buffer, fileName) {
      const bytes = new Uint8Array(buffer);
      const byteOrder = (bytes[0] << 8) | bytes[1];
      const littleEndian = byteOrder === 0x4949;

      const readUint16 = (pos) => littleEndian ? bytes[pos] | (bytes[pos + 1] << 8) : (bytes[pos] << 8) | bytes[pos + 1];
      const readUint32 = (pos) => littleEndian ? bytes[pos] | (bytes[pos + 1] << 8) | (bytes[pos + 2] << 16) | (bytes[pos + 3] << 24)
        : (bytes[pos] << 24) | (bytes[pos + 1] << 16) | (bytes[pos + 2] << 8) | bytes[pos + 3];

      const magic = readUint16(2);
      if (magic !== 42) throw new Error('Archivo TIFF inválido');

      const ifdOffset = readUint32(4);
      const numEntries = readUint16(ifdOffset);

      let width = 0, height = 0, dpiX = 72, dpiY = 72, resolutionUnit = 2;
      let colorSpace = 'unknown', hasICCProfile = false, iccProfile = undefined, dpiDetected = false;

      for (let i = 0; i < numEntries; i++) {
        const entryOffset = ifdOffset + 2 + (i * 12);
        const tag = readUint16(entryOffset);
        const type = readUint16(entryOffset + 2);

        if (tag === 256) width = type === 3 ? readUint16(entryOffset + 8) : readUint32(entryOffset + 8);
        if (tag === 257) height = type === 3 ? readUint16(entryOffset + 8) : readUint32(entryOffset + 8);
        if (tag === 282) { const vo = readUint32(entryOffset + 8); dpiX = Math.round(readUint32(vo) / readUint32(vo + 4)) || 72; dpiDetected = true; }
        if (tag === 283) { const vo = readUint32(entryOffset + 8); dpiY = Math.round(readUint32(vo) / readUint32(vo + 4)) || 72; dpiDetected = true; }
        if (tag === 296) resolutionUnit = readUint16(entryOffset + 8);
        if (tag === 262) {
          const value = readUint16(entryOffset + 8);
          if (value === 0 || value === 1) colorSpace = 'Grayscale';
          else if (value === 2) colorSpace = 'RGB';
          else if (value === 5) colorSpace = 'CMYK';
        }
        if (tag === 34675) hasICCProfile = true;
      }

      if (resolutionUnit === 3) { dpiX = Math.round(dpiX * 2.54); dpiY = Math.round(dpiY * 2.54); }
      const dpi = Math.max(dpiX, dpiY);

      const issues = [], recommendations = [];
      if (dpi < 200) { issues.push(`Resolución de ${dpi} dpi es inferior al mínimo de 200 dpi`); recommendations.push('Redimensionar imagen o usar una versión de mayor resolución'); }
      if (colorSpace === 'RGB') { issues.push('El archivo está en RGB, se recomienda convertir a CMYK'); recommendations.push('Convertir a CMYK con perfil ISONewspaper o Euroestándar'); }
      else if (colorSpace === 'unknown') issues.push('No se pudo detectar el espacio de color');
      if (!hasICCProfile) { issues.push('No se detectó perfil ICC embebido'); recommendations.push('Se recomienda embeber perfil ICC apropiado'); }

      let status = 'ready';
      if (dpi < 200 || colorSpace === 'unknown') status = 'error';
      else if (colorSpace === 'RGB' || issues.length > 0) status = 'warning';
      if (recommendations.length === 0 && status === 'ready') recommendations.push('Archivo listo para impresión en papel prensa');

      return {
        fileName, fileType: 'TIFF', fileSize: formatFileSize(buffer.byteLength),
        dimensions: { width, height, unit: 'px' },
        physicalDimensions: dpiDetected ? { width: pxToMm(width, dpi), height: pxToMm(height, dpi), unit: 'mm' } : undefined,
        resolution: { value: dpi, status: dpiDetected ? 'detected' : 'default', message: dpiDetected ? undefined : 'Resolución no detectada' },
        colorSpace, hasICCProfile, iccProfile,
        printability: { status, issues }, recommendations
      };
    }

    // EPS Analyzer
    function analyzeEPS(buffer, fileName) {
      const text = new TextDecoder('latin1').decode(buffer);

      let width = 0, height = 0;
      const bbMatch = text.match(/%%BoundingBox:\s*(-?\d+)\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)/);
      if (bbMatch) { width = Math.abs(parseInt(bbMatch[3]) - parseInt(bbMatch[1])); height = Math.abs(parseInt(bbMatch[4]) - parseInt(bbMatch[2])); }

      const hrbbMatch = text.match(/%%HiResBoundingBox:\s*([\d.-]+)\s+([\d.-]+)\s+([\d.-]+)\s+([\d.-]+)/);
      if (hrbbMatch) { width = Math.abs(parseFloat(hrbbMatch[3]) - parseFloat(hrbbMatch[1])); height = Math.abs(parseFloat(hrbbMatch[4]) - parseFloat(hrbbMatch[2])); }

      const widthMm = Math.round(width * 0.352778 * 10) / 10;
      const heightMm = Math.round(height * 0.352778 * 10) / 10;

      let colorSpace = 'unknown';
      if (text.includes('setcmykcolor') || text.includes('/DeviceCMYK')) colorSpace = 'CMYK';
      else if (text.includes('setrgbcolor') || text.includes('/DeviceRGB')) colorSpace = 'RGB';
      else if (text.includes('setgray') || text.includes('/DeviceGray')) colorSpace = 'Grayscale';

      const issues = [], recommendations = [];
      if (colorSpace === 'RGB') { issues.push('El archivo utiliza colores RGB'); recommendations.push('Convertir a CMYK para impresión'); }
      else if (colorSpace === 'unknown') { issues.push('No se pudo determinar el espacio de color'); recommendations.push('Verificar manualmente el espacio de color'); }

      let status = 'ready';
      if (colorSpace === 'RGB' || colorSpace === 'unknown') status = 'warning';
      if (recommendations.length === 0 && status === 'ready') recommendations.push('Archivo vectorial listo para impresión');

      return {
        fileName, fileType: 'EPS', fileSize: formatFileSize(buffer.byteLength),
        dimensions: { width: widthMm, height: heightMm, unit: 'mm' },
        resolution: { value: 'Vector', status: 'vector', message: 'Archivo vectorial - resolución no aplicable' },
        colorSpace, hasICCProfile: false,
        printability: { status, issues }, recommendations
      };
    }

    // ==================== UI LOGIC ====================

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultsSection = document.getElementById('resultsSection');

    let currentFile = null;

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    async function handleFile(file) {
      if (file.size > 50 * 1024 * 1024) { alert('El archivo excede el tamaño máximo de 50 MB'); return; }

      const ext = file.name.split('.').pop().toLowerCase();
      if (!['pdf', 'jpg', 'jpeg', 'tif', 'tiff', 'eps'].includes(ext)) {
        alert('Formato no soportado. Use PDF, JPG, TIFF o EPS.');
        return;
      }

      currentFile = file;
      resultsSection.classList.add('hidden');
      progressContainer.classList.remove('hidden');

      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        updateProgress(progress);
      }, 100);

      try {
        const buffer = await file.arrayBuffer();
        let result;

        switch (ext) {
          case 'pdf': result = analyzePDF(buffer, file.name); break;
          case 'jpg': case 'jpeg': result = analyzeJPG(buffer, file.name); break;
          case 'tif': case 'tiff': result = analyzeTIFF(buffer, file.name); break;
          case 'eps': result = analyzeEPS(buffer, file.name); break;
        }

        clearInterval(progressInterval);
        updateProgress(100);

        setTimeout(() => {
          progressContainer.classList.add('hidden');
          displayResults(result, file);
        }, 300);

      } catch (error) {
        clearInterval(progressInterval);
        progressContainer.classList.add('hidden');
        alert('Error: ' + error.message);
      }
    }

    function updateProgress(value) {
      progressBar.style.width = value + '%';
      progressText.textContent = Math.round(value) + '%';
    }

    async function displayResults(result, file) {
      document.getElementById('fileName').textContent = result.fileName;
      document.getElementById('fileType').textContent = result.fileType;
      document.getElementById('fileSize').textContent = result.fileSize;

      const dimUnit = result.dimensions.unit === 'mm' ? 'mm' : 'px';
      document.getElementById('dimensions').innerHTML = `<strong>Ancho:</strong> ${result.dimensions.width} ${dimUnit}<br><strong>Alto:</strong> ${result.dimensions.height} ${dimUnit}`;

      document.getElementById('physicalDimensions').textContent = result.physicalDimensions
        ? `Dimensiones físicas: ${result.physicalDimensions.width} × ${result.physicalDimensions.height} mm` : '';

      const resEl = document.getElementById('resolution');
      if (result.resolution.value === 'Vector') {
        resEl.innerHTML = '<span class="status-ready"><i class="fas fa-check-circle"></i> Vector (resolución no aplicable)</span>';
      } else {
        const resStatus = result.resolution.value >= 200 ? 'ready' : 'error';
        const icon = resStatus === 'ready' ? 'check-circle' : 'times-circle';
        resEl.innerHTML = `<span class="status-${resStatus}"><i class="fas fa-${icon}"></i> ${result.resolution.value} dpi</span>`;
        if (result.resolution.message) resEl.innerHTML += `<br><span class="text-xs text-gray-400">${result.resolution.message}</span>`;
      }

      const colorEl = document.getElementById('colorSpace');
      const colorStatus = result.colorSpace === 'CMYK' ? 'ready' : (result.colorSpace === 'RGB' ? 'warning' : 'error');
      const colorIcon = colorStatus === 'ready' ? 'check-circle' : (colorStatus === 'warning' ? 'exclamation-triangle' : 'times-circle');
      colorEl.innerHTML = `<span class="status-${colorStatus}"><i class="fas fa-${colorIcon}"></i> ${result.colorSpace}</span>`;

      const iccEl = document.getElementById('iccProfile');
      if (result.hasICCProfile) {
        const iccText = result.iccProfile ? `Perfil ICC detectado (${result.iccProfile})` : 'Perfil ICC detectado';
        iccEl.innerHTML = `<span class="status-ready"><i class="fas fa-check-circle"></i> ${iccText}</span>`;
      } else {
        iccEl.innerHTML = '<span class="status-warning"><i class="fas fa-exclamation-triangle"></i> Sin perfil ICC embebido</span>';
      }

      const printCard = document.getElementById('printabilityCard');
      const printIcon = document.getElementById('printabilityIcon');
      const printTitle = document.getElementById('printabilityTitle');
      const issuesList = document.getElementById('issuesList');
      const recsList = document.getElementById('recommendationsList');

      printCard.className = 'rounded-lg border-2 p-4 mb-4 bg-status-' + result.printability.status;

      const statusLabels = { ready: 'Listo para imprimir', warning: 'Requiere atención', error: 'No apto para impresión' };
      const statusIcons = { ready: 'check-circle', warning: 'exclamation-triangle', error: 'times-circle' };

      printIcon.className = `fas fa-${statusIcons[result.printability.status]} status-${result.printability.status}`;
      printTitle.textContent = statusLabels[result.printability.status];
      printTitle.className = `status-${result.printability.status}`;

      issuesList.innerHTML = result.printability.issues.length > 0
        ? '<p class="text-sm font-medium text-gray-700 mb-1">Problemas detectados:</p>' + result.printability.issues.map(issue => `<p class="text-sm text-gray-600 ml-2">• ${issue}</p>`).join('')
        : '';

      recsList.innerHTML = result.recommendations.length > 0
        ? '<p class="text-sm font-medium text-gray-700 mb-1 mt-2">Recomendaciones:</p>' + result.recommendations.map(rec => `<p class="text-sm text-gray-600 ml-2">• ${rec}</p>`).join('')
        : '';

      await generatePreview(file, result.fileType);
      resultsSection.classList.remove('hidden');
    }

    async function generatePreview(file, fileType) {
      const container = document.getElementById('previewContainer');
      const label = document.getElementById('previewLabel');

      container.innerHTML = '';

      if (fileType === 'JPG') {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'max-w-full max-h-[250px] object-contain rounded';
          img.alt = 'Vista previa';
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
        label.textContent = 'Imagen JPEG';
      } else if (fileType === 'PDF') {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          const page = await pdf.getPage(1);

          const scale = 1.5;
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          canvas.className = 'max-w-full max-h-[250px] object-contain rounded shadow-sm';

          await page.render({ canvasContext: context, viewport }).promise;

          const maxHeight = 250;
          if (canvas.height > maxHeight) {
            const ratio = maxHeight / canvas.height;
            canvas.style.width = (canvas.width * ratio) + 'px';
            canvas.style.height = maxHeight + 'px';
          }

          container.appendChild(canvas);
          label.textContent = `Documento PDF (página 1 de ${pdf.numPages})`;
        } catch (error) {
          container.innerHTML = '<p class="text-gray-400 text-sm">No se pudo generar vista previa del PDF</p>';
          label.textContent = '';
        }
      } else if (fileType === 'TIFF') {
        container.innerHTML = `<div class="text-center p-4"><i class="fas fa-file-image text-4xl text-gray-300 mb-2"></i><p class="text-gray-400 text-sm">Vista previa no disponible para TIFF</p></div>`;
        label.textContent = 'Archivo TIFF';
      } else if (fileType === 'EPS') {
        container.innerHTML = `<div class="text-center p-4"><i class="fas fa-vector-square text-4xl text-gray-300 mb-2"></i><p class="text-gray-400 text-sm">Vista previa no disponible para EPS</p></div>`;
        label.textContent = 'Archivo EPS (vectorial)';
      }
    }
  </script>
</body>
</html>
